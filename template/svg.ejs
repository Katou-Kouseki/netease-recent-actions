<%
fontSizeLimit = function(text, fontSize, maxWidth){
    let totalWidth = 0;
    let str = "";
    for(let char of text){
        // if its space or a number
        if(char === ' ' || /^\d+$/.test(char))
            totalWidth += fontSize * 0.7;
        // if its thin character
        else if(char.toLowerCase() === 'i' || char === 'f' || char === 'l' || char === 'j' || char === 'r' || char === 't' || char === '"' || char === "'" || char === '(' || char === ')' || char === '[' || char === ']' || char === ',' || char === '-' || char === '.')
            totalWidth += fontSize * 0.3;
        // if it's uppercase
        else if(char === char.toUpperCase())
            totalWidth += fontSize * 1.04;
        // all other symbols
        else
            totalWidth += fontSize * 0.8;
        if(totalWidth < maxWidth - 13)
            str += char;
        else
            return str + '...';
    }
    return str;
}
%>

<svg width="<%= themeConfig.width*themeConfig.column - 8.4*(themeConfig.column-1) %>" height="<%= (74+(Math.ceil(recentPlayedList.length/themeConfig.column)-1)*42)*1.4 %>" viewBox="0 0 <%= themeConfig.width*themeConfig.column - 8.4*(themeConfig.column-1) %> <%= (74+(Math.ceil(recentPlayedList.length/themeConfig.column)-1)*42)*1.4 %>" fill="none" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <rect stroke="<%= themeConfig.theme === 'light' ? '#e4e2e2' : '' %>" width="<%= themeConfig.width*themeConfig.column - 8.4*(themeConfig.column-1) %>" height="<%= (73+(Math.ceil(recentPlayedList.length/themeConfig.column)-1)*42)*1.4 %>" rx="5.6" fill="none" />
    <rect x="<%= themeConfig.width*themeConfig.column - 30 - 8.4*(themeConfig.column-1) %>" y="10" width="21" height="18.2" fill="url(#pattern-logo)" />
    <text fill="<%= themeConfig.color.fontColor %>" xml:space="preserve" style="white-space: pre" font-size="14" letter-spacing="0em">
    <tspan x="10" y="<%= 23.5 %>"><%= themeConfig.title %></tspan>
  </text>
    <%
    for (const [index, value] of recentPlayedList.entries()) {
        const ceil = index % themeConfig.column
        const row = Math.floor(index/themeConfig.column)
    %>
    <a href="<%= value.url %>" target="_blank">
        <rect x="<%= ceil*themeConfig.width + (8.4 - 8.4*ceil) %>" y="<%= (27+42*row)*1.4 %>" width="<%= themeConfig.width - 16.8 %>" height="51.8" rx="2.8" fill="<%= themeConfig.color.itemBgColor %>" fill-opacity="0.11" />
        <rect x="<%= ceil*themeConfig.width + (8.4 - 8.4*ceil) %>" y="<%= (27+42*row)*1.4 %>" width="<%= (themeConfig.width - 16.8) * value.percent %>" height="51.8" rx="2.8" fill="#4eb4f5" fill-opacity="0.11" />
        <rect x="<%= ceil*themeConfig.width + (14 - 8.4*ceil) %>" y="<%= (31+42*row)*1.4 %>" width="40.6" height="40.6" rx="2.8" fill="<%= `url(#pattern${index})` %>" />
        <text fill="<%= themeConfig.color.fontColor %>" xml:space="preserve" style="white-space: pre" font-size="11.2" letter-spacing="0em">
      <tspan x="<%= ceil*themeConfig.width + (60.2 - 8.4*ceil) %>" y="<%= (42.844+42*row)*1.4 %>"><a id="netease" target="_blank" href="<%= value.url %>"><%= fontSizeLimit(value.name, 8, themeConfig.width - 55) %></a></tspan>
    </text>
        <text fill="<%= themeConfig.color.fontColor %>" fill-opacity="0.66" xml:space="preserve" style="white-space: pre" font-size="9.8" letter-spacing="0em">
      <tspan x="<%= ceil*themeConfig.width + (60.2 - 8.4*ceil) %>" y="<%= (54.258+42*row)*1.4 %>"><%= fontSizeLimit(value.artist, 7, themeConfig.width - 55)  %></tspan>
    </text>
    </a>
    <%
    }
    %>
    <defs>
        <pattern id="pattern-logo" patternContentUnits="objectBoundingBox" width="1" height="1">
            <use xlink:href="#image-logo" transform="translate(0 -0.00103455) scale(0.00129639 0.00141336)" />
        </pattern>
        <%
        for (const [index] of recentPlayedList.entries()) {
        %>
            <pattern id="<%= `pattern${index}` %>" patternContentUnits="objectBoundingBox" width="1" height="1">
                <use xlink:href="<%= `#image${index}` %>" transform="scale(0.00333333)" />
            </pattern>
        <%
        }
        %>
        <%
        for (const [index, value] of recentPlayedList.entries()) {
        %>
            <image id="<%= `image${index}` %>" width="300" height="300" xlink:href="<%= value.cover %>" />
        <%
        }
        %>
        <image id="image-logo" width="2362" height="709" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOwAAABGCAYAAADPVHicAAAACXBIWXMAAAsTAAALEwEAmpwYAAAP90lEQVR4nO2df4gd1RXHb3Y3RURRFH8gJdKau4oYhGAQUfAXybQ6IAEhCkGo2D8UqiKWIIiUJESCIi0GhUIkJCEWQgSlgaYIUQhEArFCESEhYJG9UWJBTBOS7G5S7rxz7nznvPtm7tsfefMe54/Dm92dNzO5uZ85555f12Qv52YhxRk7Jn6hn7qDP2T87Yz5yxp5yx087YSx2ZLGSKPv3vOsf8d3vGGXvCGbvLGfucM/YOeT9n7JKF/neo6BhkLRyDxQT1Xmfs287Y4wyfBxFkZspMTk8ZW4iHuHM8Scf+b5MX8TsA8D8J3pvgfuMK7uAnlErebm9JAirM/ZxZ+xB1p4E20UCccYZO+uMvdgtk+F4qvvv/jvTBDnC67X1WYZQiuThoFJxvRMZgvrAEOZ+xDDKqAFAAtQCM42QRulArMJDMML4H7X2fsFmfstfASUTO5BRNMJW8HsAyrh8QZuw1AnSVNStqSYesL0p7wltFtraF4ynRncY87YtbEXioqOQCYzAXUIPmcsaudsZ+S6avN2W9Ri3WnaVWnDekPcANL4NLEXB3OGOvVGgHP8FU8sEBK9aqr5Ra1V5gOMv156KAGjGXK+DOkIb3x1+yR3nKTKqmVXjMKIxB37DS+nA7hF+8+csadqFM37mCW6yROy+Q4vgnZ+wahXbwE00lv3zqxLnbGfkAlMHt/F1KolhCjl73qe75+JTWSvcdcptApNNgJjkLxmdcZOOGP/QTBcEOAsJKzF9aY6Zi05ljhGG2K27HmO3J9N5I72hXt0wrt4CecSr74GpaA3UnadBFhrcDmHUkEXFU48aLmOVATM7T+/AcVWoUmG+IxSDWFN9M6FbzAC20Cl84jEWM9QV5f/wxbnbEfOmN/gDX0bG9oJyW0PtFiEv9tKjoG2RCNQUqcdZ03T8n7OldYu9ai4jqc3eQ1OMN10hn7LIdnxLP6Ix9swe0EWdUAT6vab33+Aq6jiZXtGASquTzAxY066+dsT8KLZUKq0icKIRzhYNnmTWjuMfXzthb8XkoV3hchJaeAWg5/htdE5O2vkDnblMtq6BkQzgGtXJNkX69Zp19+aVWjRjnYrPbghIwoT+1lLnnXGeVnfrqXeGGeGIP24k0/js+ABkaYF5+wfLP1aC9HMbIBOZsAAAAASUVORK5CYII=" />
        <style type="text/css">
            a {
                text-decoration: none;
            }

            text {
                font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol;
            }
        </style>
    </defs>
</svg>
